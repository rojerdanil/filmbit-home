  <h4 class = "flimBitSectionHead"> Movies Management </h4>
<div class = "flimBitMainDiv">  
  
<div class="d-flex align-items-center gap-3 flex-wrap divPart">
  <select id="languageFilter" class="form-select form-select-sm w-auto">
    </select>

  <span class="movie-label-highlight">
  🎬 Total Movie: <span id="movieCount">(0)</span>
</span>
<span class="movie-label-highlight">
   Total Filtered: <span id="movieCountFilter">(0)</span>
</span>
<div style = "margin-left:29%;width: 32%;">
   <button class="btn" onclick="addMovieDropClick();" id="btnAddMovie" style = "margin-left: 35%;">+ Add</button>
    <button class="btn" onclick="updateSelectedMovie()">✏️ Update</button>
    <button class="btn" onclick="deleteMovies()">🗑️ Delete</button>
	
</div>
</div>

<div class="table-toolbar d-flex justify-content-between align-items-center mb-2">
  <div></div> <!-- Left empty because search box will float left via DataTables -->
  <div>
  
      
 
  </div>
</div>



<div class = "divPart">

	  <table id="movieTable" class="display  table-hover" style="width: 100%;">


	  
    <thead class="table-light">
 <tr>
     <th class= ""> </th>

<th><input type="checkbox" class="select-all"></th>
   
    <th>Title</th>
    <th>Description</th>
    <th>Budget</th>
    <th>P/S</th>
    <th>Live</th>
    <th>Status</th>
    <th>Trailer</th>
    <th>Action</th>
	   

  </tr>
    </thead>
	
  </table>
  
  </div>
  
</div>  
<script>
var updateMovieId  = 0;
var isUpdateMovie = false;
var exitPosterUrl = "";

var updateMovieModalWindow = function openModelWinForUpateMov()
{
   isUpdateMovie = true;
   $("#addMovieLabel").text("🎬 Update Movie");
   console.log("update movie modal " + movieLanuguageList.length);
    if (movieLanuguageList != null && movieLanuguageList.length > 0) {
	  	       populateLanguageSelect("mLanguageSelect", movieLanuguageList,"addlanguage");
	  }
			   

		if (Object.keys(idNameMovieTypeMap).length > 0) { 
                 var arrayObj = convertMapToArray(idNameMovieTypeMap);
	  	       populateLanguageSelect("addmovieTypeSelect", arrayObj,"");
			   }	
			   
			  if (Object.keys(idNameMovieStatusMap).length > 0) { 
			                    var arrayObj = convertMapToArray(idNameMovieStatusMap);

	  	       populateLanguageSelect("addstatusSelect", arrayObj,"");
			   }	
    sendAjaxRequest(readMovieEintyByMovIdUrl+updateMovieId, "GET", getAppHeaer(), null,readMovEntityUpdateCall );

   
}
function updateSelectedMovie()
{
var data={};
   var ids=[];
   $("#movieTable").find("tr").each(function()
   {
       if($(this).hasClass("row_selected"))
	   {
	     var id=parseInt($(this).find("td:nth-child(2) input[type='checkbox']").val());
		 //(id);
		 console.log(id);
		 ids.push(id);
		}
	  
   });
   if( ids.length == 1)
  {
	updateMovieId = ids[0];
	  openDropDownWithCallBack('#addMovieModal','add-movie-modal.html',updateMovieModalWindow);

      //sendAjaxRequest(readMovieEintyByMovIdUrl+updateMovieId, "GET", getAppHeaer(), null,readMovEntityUpdateCall );

	
  } 
   else if(ids.length==0)
   alert("please select any one row");
  else if( ids.length > 1)
    alert("do not select more than one");
   
   
}

var  readMovEntityUpdateCall = function readMovEntityUpdate(response)
{
 if(response != null)
  {
	if(response.status == "success")
	{
	  setAllAddMovieForm(response.result);
	}
	else {
        if(response.status === "failure")
		    alert("❌ Failed to save movie. " + response.message);
 }	

}
}
 function deleteMovies()
 {  
   var data={};
   var ids=[];
   data.ftype="deleteItems";
   $("#movieTable").find("tr").each(function()
   {
       if($(this).hasClass("row_selected"))
	   {
	     var id=parseInt($(this).find("td:first").find("a").attr("value"));
		 //(id);
		 ids.push(id);
		}
	  
   });
   if(ids.length==0)
   alert("please select one row");
  else
  {
   data.ids=ids;
   var inp=JSON.stringify(data);
   console.log(inp);
   /*$.post("",inp,
   function(data,status){
   if(status=="success")
   {
     
	  $("#md").hide();
	   $("#itemTable").dataTable().fnDestroy();
	   $("#itemTable").html('');
	   $("#itemTable").css("width","100%");
	   getItemTable();
	
   } 
   else
   {
   alert("network error");
   }
 
 });*/
 }
}	
	function saveMovie() {
  const form = document.getElementById('movieForm');
  form.classList.remove('was-validated');

  // Reset field styles
  form.querySelectorAll('input, select').forEach(field => {
    field.classList.remove('is-invalid', 'is-valid');
  });

  let isValid = true;

  // Required fields
  const requiredFields = form.querySelectorAll('[required]');
  requiredFields.forEach(field => {
    if (!field.value.trim()) {
      field.classList.add('is-invalid');
      isValid = false;
    }
  });

  // Budget and Per Share Amount validation
  const budgetField = document.getElementById('budget');
  const perShareField = document.getElementById('addperShareAmount');
  const budgetError = document.getElementById('budgetError');
  const perShareError = document.getElementById('perShareError');

  const budgetVal = budgetField.value.trim();
  const perShareVal = perShareField.value.trim();

  const isBudgetInteger = /^\d+$/.test(budgetVal);
  const isPerShareInteger = /^\d+$/.test(perShareVal);

  const fileInput = document.getElementById("addposterFile");
  const posterFile = fileInput.files[0];
  console.log("file url"+ posterFile);

  if (!isBudgetInteger) {
    budgetField.classList.add('is-invalid');
    budgetError.innerText = "❌ Budget must be a whole number.";
    isValid = false;
  }

  if (!isPerShareInteger) {
    perShareField.classList.add('is-invalid');
    perShareError.innerText = "❌ Per Share must be a whole number.";
    isValid = false;
  }

  if (isBudgetInteger && isPerShareInteger) {
    const budgetInt = parseInt(budgetVal, 10);
    const perShareInt = parseInt(perShareVal, 10);
    if (perShareInt >= budgetInt) {
      perShareField.classList.add('is-invalid');
      perShareError.innerText = "❌ Per Share must be less than Budget.";
      isValid = false;
    } else {
      budgetField.classList.add('is-valid');
      perShareField.classList.add('is-valid');
    }
  }


/*
   const shareTimeInput = document.getElementById("shareStartTime");
const shareTimeValue = shareTimeInput.value.trim();

if (!shareTimeValue) {
  shareTimeInput.classList.add("is-invalid");
  document.getElementById("shareTimeError").innerText = "⛔ Sharing start time is required.";
  return;
}*/

// Convert to Date object for comparison

/*const selectedDateTime = new Date(shareTimeValue);
const currentDateTime = new Date();
if (selectedDateTime <= currentDateTime) {
  shareTimeInput.classList.add("is-invalid");
  document.getElementById("shareTimeError").innerText = "⏳ Please select a future date and time.";
  return;
} else {
  shareTimeInput.classList.remove("is-invalid");
}*/



  // Date validation (you already have)
  const releaseField = document.getElementById('addreleaseDate');
  const trailerField = document.getElementById('addtrailerDate');
  const releaseDateVal = releaseField.value;
  const trailerDateVal = trailerField.value;
  const releaseDateError = document.getElementById('releaseDateError');
  releaseDateError.innerText = "Please select a release date.";

  if (releaseDateVal && trailerDateVal) {
    const release = new Date(releaseDateVal);
    const trailer = new Date(trailerDateVal);
	
	 console.log(releaseDateVal + " : "+ trailerDateVal);

    if (release <= trailer) {
      releaseField.classList.add('is-invalid');
      trailerField.classList.add('is-invalid');
      releaseDateError.innerText = "❌ Release date must be after trailer date.";
      isValid = false;
    } else {
      releaseField.classList.add('is-valid');
      trailerField.classList.add('is-valid');
    }
  }
  
  if(typeof posterFile != 'undefined')
  {
  if (!posterFile || !posterFile.type.startsWith("image/")) {
    fileInput.classList.add("is-invalid");
    document.getElementById("posterError").innerText = "❌ Please select a valid image file.";
    return;
  } else {
    fileInput.classList.remove("is-invalid");
  }
  
  }
  const trailerUrlInput = document.getElementById("addtrailerUrl");
const trailerUrl = trailerUrlInput.value.trim();

// Simple URL format validation
const urlPattern = /^(https?:\/\/)[^\s$.?#].[^\s]*$/;

if (trailerUrl && !urlPattern.test(trailerUrl)) {
  trailerUrlInput.classList.add("is-invalid");
  document.getElementById("trailerUrlError").innerText = "❌ Please enter a valid trailer URL (starting with http:// or https://)";
  return;
} else {
  trailerUrlInput.classList.remove("is-invalid");
}




  if (isValid) {
  
 // console.log(buildMovieObjectFromUI());
 // closeModelWindowById("addMovieModal");
    movieData =   buildMovieObjectFromUI()
	
	if(isUpdateMovie == true)
	{
	   movieData.id = updateMovieId;
	   movieData.isEdit = true;
	   
	   movieData.posterUrl = exitPosterUrl;
	
	}  
	
  const formData = new FormData();
formData.append("movie", new Blob([JSON.stringify(movieData)], { type: "application/json" }));
formData.append("poster", document.getElementById('addposterFile').files[0]);

fetch(addMovieUrl, {
  method: "POST",
  body: formData,
  headers: getAppHeaer()
}).then(response => {
    if (!response.ok) {
      // ✅ HTTP error (like 400, 401, 500)
      throw new Error("Server returned error: " + response.status);
    }
    return response.json(); // Or response.text() if not JSON
  })
  .then(data => {
    // ✅ Success callback
    console.log("🎉 Movie saved successfully:", data);
	if(data.status.trim() === "success")
	{
	console.log("succe");
	    closeModelWindowById("addMovieModal");
		    currentTable.ajax.reload();
 
	}
	else
    alert("✅"+data.message);
    // Optional: refresh datatable, reset form, close modal, etc.
  })
  .catch(error => {
    // ❌ Failure callback
    console.error("⚠️ Failed to save movie:", error);
    alert("❌ Failed to save movie. " + error.message);
  });
  
   
    // Proceed to submit
  } else {
    form.classList.add('was-validated');
  }
}

function buildMovieObjectFromUI() {

const posterInput = document.getElementById('addposterFile');
 posterUrlx  = "";
const file = posterInput.files[0];

if (file) {
  const previewURL = URL.createObjectURL(file);
  console.log("Preview URL:", previewURL);
  posterUrlx =previewURL;
  // Example: Set preview image
}


   var releDate = toFullSqlTimestamp($("#addreleaseDate").val());
   var trailDate = toFullSqlTimestamp($("#addtrailerDate").val());


  const movie = {
    title: document.getElementById('title').value.trim() || "",
    description:document.getElementById('description').value.trim() || "", // If you add description input later
    language: document.getElementById('mLanguageSelect').value || "",
    budget: parseInt(document.getElementById('budget').value.trim()) || 0,
    releaseDate: releDate || "",
    trailerDate: trailDate || "",
    status: parseInt(document.getElementById('addstatusSelect').value) || 0,
    perShareAmount: parseInt(document.getElementById('addperShareAmount').value.trim()) || 0,
    movieTypeId: parseInt(document.getElementById('addmovieTypeSelect').value) || 0,
    posterUrl: posterUrlx,
    trailerUrl: document.getElementById('addtrailerUrl').value.trim() || "",
	activeStatus : document.getElementById('addVisibleSelect').value || ""
  };

  return movie;
}
function setAllAddMovieForm(input)
{
   exitPosterUrl = input.posterUrl;
      console.log("status :: " + exitPosterUrl);

   $("#title").val( input.title);
//$("#shareStartTime").val( input.);
   $("#description").val(input.description );
   $("#mLanguageSelect").val(input.language );
   $("#budget").val(input.budget);
   input.releaseDate ? $("#addreleaseDate").val(input.releaseDate.replace(" ", "T").substring(0, 16)) : null;
   input.trailerDate ? $("#addtrailerDate").val(input.trailerDate.replace(" ", "T").substring(0, 16)) : null;
   $("#addperShareAmount").val(input.perShareAmount);
   $("#addstatusSelect").val(input.statusId);
   $("#addmovieTypeSelect").val(input.movieTypeId );
   $("#addtrailerUrl").val(input.trailerUrl != null ? input.trailerUrl : "");
   $("#addVisibleSelect").val(input.status != null ? input.status : "");
  // $("#addreleaseDate").val(input.releaseDate);
  // $("#addtrailerDate").val(input.trailerDate );
  // $("#addstatusSelect").val(input. );

}

function addMovieDropClick()
{
isUpdateMovie = false;
      openDropDownWithCallBack('#addMovieModal','add-movie-modal.html',setMovieAddSelect);
	  
	  

 
  }
  
  function formatExpandMovieRow(rowData) {
  return `
    <div style="padding: 10px 20px; background-color: #f9f9f9; border-left: 4px solid #007bff;">
	          <span class="date-icon">📅</span> <span class="date-label">UpdatedDate:</span> <span class="date-value">${formatDateTime(rowData.updatedDate)}</span>
	  &nbsp;&nbsp  
      <span class="date-icon">📅</span> <span class="date-label">Created:</span> <span class="date-value">${formatDateTime(rowData.createdDate)}</span>
	  &nbsp;&nbsp  
      <span class="date-icon">🎞️</span> <span class="date-label">Trailer:</span> <span class="date-value">${formatDateTime(rowData.trailerDate)}</span>
       &nbsp;&nbsp  
      <span class="date-icon">🎬</span> <span class="date-label">Release:</span> <span class="date-value">${formatDateTime(rowData.releaseDate)}</span>
       <div> <strong>   ${formatNA(rowData.description)} </strong> </div>
	  </div>
	
	   
  `;
}
  
  function loadMovieSection()
	{
	
	var mvTable = $('#movieTable').DataTable({
		stripeClasses: [],
		     dom: '<"top"f>rt<"bottom"p><"clear">', // Only filter (f), remove length (l)
    pageLength: 10,
    lengthChange: false ,// hides "Show entries" dropdown
	processing: true,
    serverSide: true,
	   ajax: {
        url: readMovieUrl,
        type: 'POST',
        contentType: 'application/json',
		headers: getAppHeaer(),
        data: function (d) {
		 d.language =  $('#languageFilter').val();

  return JSON.stringify(d);                // 👈 no wrapper!
        },
		dataFilter: function (responseStr) {
        const fullResponse = JSON.parse(responseStr);
        const obj = fullResponse.result;
        $("#movieCount").text(obj.recordsTotal ?? 0);
	    $("#movieCountFilter").text(obj.recordsFiltered);

      // Debug: make sure obj is valid
      return JSON.stringify({
        draw: obj.draw > 0 ? obj.draw : 1,
        recordsTotal: obj.recordsTotal ?? 0,
        recordsFiltered: obj.recordsFiltered ?? 0,
        data: obj.data ?? []
      });
    },
    error: function (xhr, status, error) {
      console.error('AJAX Error:', error);
	  Alert("Issue on dataLoading");
    }
      },
 columns: [
      {
        className: 'dt-control',
        orderable: false,
        data: null,
        defaultContent: ''
      },
 
        {
          data: 'id',
          orderable: false,
          render: function (data) {  
            return `<input type="checkbox" class="rowCheckbox" value="${data}" onclick="enableRowSelected(this)">`;
          }	
        },
        {
      data: 'title',
      render: function (data, type, row) {
        const status = row.activeStatus === 'active';
        const color = status ? 'green' : 'red';
        const dot = `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${color};margin-right:8px;"></span>`;
        return `${dot}${data}`;
      }
    },
        { data: 'language' 
		   ,
		render: function(data, type, row)  {
		
		    const lang = row.languageName || 'N/A';
           const typeName = row.typeName || 'N/A';
		
return `
      <div class="type-column">
        <span class="type-lang">${lang}</span>
        <span class="type-dot"> · </span>
        <span class="type-name">${typeName}</span>
      </div>
    `; 
          }
		
		},
       // { data: 'budget' },
       		{
  data: 'shareSoldAmount',
  render: function(data, type, row) {
    const percent = row.fundingPercent || 0;
    const sold = row.sharesSold * row.perShareAmount;
    const total = row.totalShares * row.perShareAmount;

    return `
      <div>
        ₹${sold.toLocaleString()} 
        <small style="color:#888;">of ₹${total.toLocaleString()}</small>
        <div class="progress" style="height: 6px; margin-top: 4px;">
          <div class="progress-bar bg-success" role="progressbar" style="width: ${percent}%;" aria-valuenow="${percent}" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
      </div>`;
  }
}
,
{ data: 'perShareAmount' },
 
		 
		 
		 { 
      data: 'shareStatus', // or however you're mapping statusId
      render: function(data, type, row) {
       const colorMap = {
      'Live': 'badge-success',
      'Sold Out': 'badge-dark',
      'Not Started': 'badge-secondary',
      'Closed': 'badge-danger',
      'Day-Before Only': 'badge-warning'
    };
	const dayBending = row.daysBeforeRelease;
    const badgeClass = colorMap[data] || 'badge-info';
    return `<span class="badge ${badgeClass}">${data || 'N/A'} ${dayBending || 'N/A'}</span>`;
      }
    },
        { data: 'statusId' ,
          render: function (data) {
        let status = getValueFromMap(idNameMovieStatusMap,data);
       const badgeMap = {
      'idea stage': 'badge-idea',
      'pre-production': 'badge-pre',
      'funding open': 'badge-funding-open',
      'funding closed': 'badge-funding-closed',
      'production': 'badge-production',
      'post-production': 'badge-post',
      'trailer released': 'badge-trailer',
      'coming soon': 'badge-coming',
      'released': 'badge-released',
      'box office running': 'badge-boxoffice',
      'profit distribution': 'badge-profit',
      'archived': 'badge-archived',
      'on hold': 'badge-hold',
      'cancelled': 'badge-cancelled'
    };
    const badgeClass = badgeMap[status.toLowerCase()]; // default fallback
    return `<span class="">${status}</span>`;
  }
           
		
			   

		
		}
	/*,
        { data: 'typeName',
		render: function (data) {
            return data;
          }

		}*/
		,
		{
          data: 'trailerUrl',
          render: function (data) {
     if (!data) return 'N/A';
    const videoId = extractYouTubeVideoID(data);
    if (!videoId) return `<span>${data}</span>`;

    const thumbnail = `https://img.youtube.com/vi/${videoId}/0.jpg`;
    return `
      <div class="preview-hover">
        <a href="${data}" target="_blank" style="text-decoration: none; color: inherit;">
          Watch
        </a>
        <div class="preview-box">
          <img src="${thumbnail}" alt="Trailer Preview">
        </div>
      </div>`;
	  
	  
	  
          }
        }
		,
        {
          data: 'posterUrl',
  render: function (data, type, row) {
    const safeTitle = row.title ? row.title.replace(/'/g, "\\'") : '';
const percent = row.fundingPercent || 0;
        const total = row.totalShares;

          return `
      <span class="action-button" onclick="viewMovie(${row.id})">🔍</span>
	  <span class="action-button" onclick="manageCast(${row.id}, '${safeTitle}')">👤</span>
      <span class="action-button" onclick="activateDayBefore(${row.id}, '${row.title.replace(/'/g, "\\'")}',${total},${row.perShareAmount})">💼</span>
  `;
          }
        }
      ],
	   language: {
    emptyTable: "🔍 No records found matching your criteria."
  },
    drawCallback: function () {
      //enableCheckboxSelectAll('movieTable');
    },
    initComplete: function () {
      const table = this.api();
      $(table.rows().nodes()).off('click').on('click', function (e) {
        if ($(e.target).is('input')) return;

        if($(this).hasClass("row_selected"))
							{
							 $(this).removeClass("row_selected");
							 var $checkboxValue=$(this).find("input:checkbox");
						     $checkboxValue.prop('checked',false);
							}
							else
							{
							 $(this).addClass("row_selected");
							 var $checkboxValue=$(this).find("input:checkbox");
							 $checkboxValue.prop('checked',true);
							}
      });
    },
    columnDefs: [
      { targets: 0, orderable: false, className: 'no-sort' }
    ]
	  
	
	
		   }
		   );
		   

$('#movieTable tbody').off('click', 'td.dt-control').on('click', 'td.dt-control', function () {
    const tr = $(this).closest('tr');
    const row = mvTable	.row(tr);

    if (row.child.isShown()) {
      row.child.hide();
      tr.removeClass('shown');
    } else {
      row.child(formatExpandMovieRow(row.data())).show();
      tr.addClass('shown');
    }
  });






		   $('#movieTable_filter input')
  .off() // unbind default search event
  .on('keyup', function (e) {
    if (e.key === 'Enter') {
      mvTable.search(this.value).draw();
    }
  });
	console.log(movieLanuguageList.length);
	if (!movieLanuguageList || movieLanuguageList.length > 0) {
	       populateLanguageSelect("languageFilter", movieLanuguageList,"language")

	  
           }


$('#languageFilter').on('change', function () {
    mvTable.ajax.reload();
  });
  
  
  currentTable = mvTable;
	
	}

  
  function callMovieTable()
  {
  $('#movieTable').DataTable({
      serverSide: true,
      processing: true,
      ajax: {
        url: '/api/movies', // Replace with your backend URL
        type: 'GET',
        dataSrc: function (json) {
          // You can transform data here if needed
          return json.data;
        }
      },
     columns: [
  {
    data: 'id',
    orderable: false,
    render: function (data) {
      return `<input type="checkbox" class="rowCheckbox" value="${data}">`;
    }
  },
  { data: 'title' },
  { data: 'description' },
  { data: 'language' },
  { data: 'budget' },
  { data: 'perShareAmount' },
  { data: 'statusId' },
  { data: 'movieTypeId' },
  {
    data: 'posterUrl',
    render: function(data) {
      return `<img src="${data}" width="50" height="50"/>`;
    }
  },
  {
    data: 'trailerUrl',
    render: function(data) {
      return `<a href="${data}" target="_blank">Trailer</a>`;
    }
  },
  {
    data: 'createdDate',
    render: function(data) {
      return new Date(data).toLocaleDateString();
    }
  },
  {
    data: 'releaseDate',
    render: function(data) {
      return data ? new Date(data).toLocaleDateString() : 'Coming Soon';
    }
  },
  {
    data: 'id',
    render: function(data) {
      return `<button onclick="editMovie(${data})">Edit</button> <button onclick="deleteMovie(${data})">Delete</button>`;
    }
  }
]
,
      pageLength: 10,
      lengthMenu: [10, 20, 50, 100]
    });
  
  
  }

</script>

<style>
.modal {
  
  width: 100%; height: 100%;
  background-color: rgba(0,0,0,0.6);
  font-family: Arial, sans-serif;
}


</style>