<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FilmBit Admin Panel</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>


  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="adminPanel.css">

<script>

    var baseUrlApi = 'http://localhost:8080';
	var readMovieUrl = baseUrlApi + "/movie/datatable";
    var readMovieStatusUrl = baseUrlApi + "/movie-status/allstatus";
    var readMovieTypeUrl = baseUrlApi + "/movie-types/alltypes";
	var readMovLanguageUrl = baseUrlApi + "/languages/alllangugage";
	var readMovSummaryByIdURl = baseUrlApi + "/movie/moviebyId?id=";
	var readActorsBylanIdUrl = baseUrlApi +"/movie-person/movie_by_languagae?id=";
	var readMovieRolesUrl = baseUrlApi + "/roles-in-movie/getAllRole";
	var addMovieRoleUrl   =   baseUrlApi + "/roles-in-movie/addRoleInMovie"
	var addMovieUrl =  baseUrlApi + "/movie/addMovie"
	var readActorInMovByMovIdUrl = baseUrlApi  + "/actors-in-movie/actorsInMovieById?id=";
	var addActorInMovieUrl = baseUrlApi  + "/actors-in-movie/addMovieActor";
    var deleteActorInMovieUrl = baseUrlApi  + "/actors-in-movie/deleteMoviePlay?id=";
	var readShareTypeByMovIdUrl = baseUrlApi  + "/share-types/movie/" ;
	var addUpdateShareTypeUrl = baseUrlApi + "/share-types/updateInsert/";
	var deleteShareTypeUrl = baseUrlApi + "/share-types/deleteShareType/";
	var readMovieEintyByMovIdUrl = baseUrlApi + "/movie/entity/moviebyId?id=";



	
	
    let currentTable;
	let idNameMovieStatusMap = {};
	let idNameMovieTypeMap = {};
	let movieLanuguageList = [];
	
	let  languageMap = 	[];
	let  actorRolelist = [];

    function loadSection(section) {
	
	console.log(section);
	if (Object.keys(idNameMovieStatusMap).length === 0) {
	 sendAjaxRequest(readMovieStatusUrl, "GET", getAppHeaer(), null,readMovieCallBack );
	 }
	 if (Object.keys(idNameMovieTypeMap).length === 0) {
	 	 sendAjaxRequest(readMovieTypeUrl, "GET", getAppHeaer(), null,readMovieTypeCallBack );

	 }
        if (!movieLanuguageList || movieLanuguageList.length === 0) {
	        sendAjaxRequest(readMovLanguageUrl, "GET", getAppHeaer(), null,readLanguageCallBack );

	 }
	
      const sections = ['dashboard', 'movies', 'actors', 'roles', 'users', 'investments', 'reports', 'announcements', 'payouts', 'settings','offerPromotion'];
      sections.forEach(id => {
        document.getElementById(`${id}-section`).style.display = 'none';
      });
      document.getElementById(`${section}-section`).style.display = 'block';
	  
	  var pageName = section +"-section.html";
	  var currId = "#"+section +"-section";
	  console.log(currId);
      if($(currId).children().length === 0)
	      {
		  $(currId).load(pageName, function () {
		  if(section == 'dashboard')
		      loadDashBoardDetails();
		  if(section == 'movies')
              loadMovieSection();
          if(section == 'announcements')
                 renderAnnouncementsTable();
          if(section == 'reports')
		     renderReportCharts();
		  if(section == 'users')
		     loadUserSection();
		  if(section == 'actors')
	         loadActorSection();	
          if(section == 'offerPromotion')
	         loadOfferPromotionSection();				 
		  });
		  		 
		  
           }
	 
	  // Clear existing highlights
  $('.sidebar .nav-link').removeClass('active');

  // Highlight the matching menu item
  $(`.sidebar .nav-link[data-section="${section}"]`).addClass('active');



  // Highlight the matching menu item
	  $('.sidebar .nav-link').each(function () {
    const linkText = $(this).text().trim().toLowerCase();
    if (linkText.includes(section.toLowerCase())) {
	console.log("test"+section);
      $(this).addClass('active');
    }
  });

  
    }

function loadOfferPromotionSection()
{

}
	
const readMovieTypeCallBack = function (response) {
  if(response != null)
  {
  items = response.result;
   if (Array.isArray(items)) {
  for (let i = 0; i < items.length; i++) {
    const item = items[i];
    idNameMovieTypeMap[item.id] = item.name;
  }
  }
  }
  
};

function getKeyValueMapIdName(items)
{
var idNameMapx = {};
  if (Array.isArray(items)) {
  
  for(let i = 0; i < items.length; i++) {

    const item = items[i];

    idNameMapx[item.id] = item.name;
  }
  
  }
  
  
  return idNameMapx;
 }



function convertMapToArray(idNameMap)
{

const idNameArray = [];

for (let key in idNameMap) {
  if (idNameMap.hasOwnProperty(key)) {
    idNameArray.push({
      id: parseInt(key),
      name: idNameMap[key]
    });
  }
}

return idNameArray;
}

const readLanguageCallBack =   function (response) {


  if(response != null)
  {
	if(response.status == "success")
	{
	   movieLanuguageList = response.result;


	   		 languageMap = getKeyValueMapIdName(movieLanuguageList);


	 } 
  }
  
  
}; 	
	function populateLanguageSelect(selectId, languageList,selectType) {
  const select = document.getElementById(selectId);
  console.log("selectId" + selectId);
  
  select.innerHTML = ""; // Clear previous options

  // Add default "All Languages" option
  const defaultOption = document.createElement("option");
  if(selectType == "language")
  {
  defaultOption.value = "";
  defaultOption.text = "üåê All Languages";
  select.appendChild(defaultOption);
  }
  else
  {
  defaultOption.value = "";
  defaultOption.text = "Please select";
  defaultOption.disabled = true;
defaultOption.selected = true;
  select.appendChild(defaultOption);
  }


  // Add languages from array
  
  
   languageList.forEach(lang => {
    const option = document.createElement("option");
	
	 if(selectType == "language")
  {
    option.value = lang.id	;
    option.text = `${lang.name} (${lang.nativeScript})`;
    select.appendChild(option);
	}
	else if(selectType == "addlanguage")
  {
    option.value = lang.id;
    option.text = `${lang.name} (${lang.nativeScript})`;
    select.appendChild(option);
	}
	else
	{
	option.value = lang.id;
    option.text = lang.name;
    select.appendChild(option);
	}
  });
  
}
	
const readMovieCallBack = function (response) {
  console.log("Response:", response);
  if(response != null)
  {
  items = response.result;
   if (Array.isArray(items)) {
  for (let i = 0; i < items.length; i++) {
    const item = items[i];
    idNameMovieStatusMap[item.id] = item.name;
  }
  }
  }
  
};
 
	function getValueFromMap(mabObj,keyToFind)
	{
	if (Object.keys(mabObj).length === 0) {
  	   return ""+keyToFind;
} else {
  const value = mabObj[keyToFind];

if (value !== undefined) {
  return value;
} else {
  	   return ""+keyToFind;

}
  
}
	
	}
	
	
	function sendAjaxRequest(url, method, headers, body, onSuccess) {
  $.ajax({
    url: url,
    type: method.toUpperCase(),
    contentType: 'application/json',
    headers: headers || {},
    data: method.toUpperCase() === 'GET' ? null : JSON.stringify(body),
    success: function (response) {
      if (typeof onSuccess === 'function') {
        onSuccess(response);
      } else {
        console.log("‚úÖ Success:", response);
      }
    },
    error: function (xhr, status, error) {
      
        alert("‚ùå Error: " + (xhr.responseText || error));
      
    }
  });
}

	
	
	
	
	
	
	
	
	
	
	
	
	
	let actorTable;
  let actorModal;

function loadActorSection()
{

  
    actorTable = $('#actorTable').DataTable({
	stripeClasses: [],

      pageLength: 10,
	  lengthChange: false
	  
    });

    $('#actorSearch').on('input', function () {
      actorTable.search(this.value).draw();
    });

  
   

}

	function loadUserSection()
	{
	
	const table = $('#userTable').DataTable({
      pageLength: 5
    });

    $('#userSearch').on('input', function () {
      table.search(this.value).draw();
    });
	}
	
	function  loadDashBoardDetails()
	{
	new Chart(document.getElementById('investmentChart'), {
      type: 'line',
      data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
        datasets: [{
          label: 'Investment (‚Çπ)',
          data: [20, 40, 60, 80, 100, 120],
          fill: false,
          borderColor: '#FFD700',
          tension: 0.4
        }]
      }
	  
    });

    // User Growth Chart
    new Chart(document.getElementById('userChart'), {
      type: 'bar',
      data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
        datasets: [{
          label: 'New Users',
          data: [150, 200, 300, 250, 400, 500],
          backgroundColor: '#ffdd57'
        }]
      }
    });

    // Profit Distribution Chart
    new Chart(document.getElementById('profitChart'), {
      type: 'pie',
      data: {
        labels: ['Investor Earnings', 'Company Profit'],
        datasets: [{
          data: [85, 15],
          backgroundColor: ['#00c851', '#ffbb33']
        }]
      }
    });
	
		   

	
	}
	function formatDate(dateStr) {
    if (!dateStr) return 'N/A';
    const d = new Date(dateStr);
    return isNaN(d) ? 'Invalid Date' : d.toLocaleDateString();
  }
  function getAppHeaer()
  {
  
  
      var headerObj = {};
	  headerObj.deviceId = 'xxx';
	  headerObj.phoneNumber = 999;
	   headerObj.accessToken = 'xdfsdf';
  
       /*   {
    
	           'deviceId' : 'xxx',
			   'phoneNumber' : 999,
			   'accessToken' : 'xdfsdf'
          }*/
		  
		  return headerObj;
  
  }
  
  function enableCheckboxSelectAll(tableId) {
  const $table = $('#' + tableId);
  console.log("button clicked");
  const $selectAll = $table.find('thead input[type="checkbox"].select-all');

  // Handle header checkbox click
  $selectAll.on('change', function () {
    console.log("header checkbox clicked");
    const isChecked = $(this).prop('checked');
    $table.find('tbody input[type="checkbox"].row-checkbox').prop('checked', isChecked);
  });

  // Handle individual row checkbox click
  $table.on('change', 'tbody input[type="checkbox"].row-checkbox', function () {
    const total = $table.find('tbody input[type="checkbox"].row-checkbox').length;
    const checked = $table.find('tbody input[type="checkbox"].row-checkbox:checked').length;
    $selectAll.prop('checked', total === checked);
  });
}
  
	
	
function formatDate(value) {
  if (!value) return 'N/A';
  const date = new Date(value);
  return date.toLocaleDateString('en-IN', {
    day: '2-digit', month: 'short', year: 'numeric'
  });
}


function updateSelectedActor()
{


}

function openDropDownWithCallBack(modalId,page,onSuccess)
{


    $("#modalContainer").empty();

    $('#modalContainer').load(page, function () {
      $(modalId).modal('show');
	  onSuccess();
    });
  
  



}

var  openShareTypeWinCallBack = function ()
{
console.log("comming inside");
$("#movieNameHead").text(currentMovieName);

loadShareTypes(currentCastMovId);



}

function loadShareTypes(movieId) {

totalShares  = currentMovieShare ;
$("#totalShares").text(totalShares); 
$("#pricePerShare").val(currentMoviePerShare);
$("#editUnallocated").text(totalShares); 
	
  $.ajax({
    url: readShareTypeByMovIdUrl +movieId,
    type: 'GET',
	headers: getAppHeaer(),

    success: function(response) {
      const tbody = $('#shareTypeTableBody');
      tbody.empty();
       data = response.result;
      if (data.length === 0) {
        tbody.append('<tr><td colspan="9" class="text-center">No share types found</td></tr>');
        return;
      }
     totalSoldShare = 0;
	 totalAllocatedShare = 0;
	 totalPlatformCommission = 0;
	 totalProfitCommission = 0;
	 isBudgetDone = false;
	 sharePerAmount = 0;
      data.forEach(item => {
	  
	  if(!isBudgetDone)
	  {
		 isBudgetDone = true;
		 sharePerAmount = item.perShareAmount
		 }
  const commission = `${item.companyCommissionPercent}% / ${item.profitCommissionPercent}%`;
  const remainShareType = item.numberOfShares - item.soldShare ;
  totalSoldShare = totalSoldShare +  item.soldShare;
  totalAllocatedShare = totalAllocatedShare +item.numberOfShares ;
  totalPlatformCommission = totalPlatformCommission + item.companyCommission;
  totalProfitCommission = totalProfitCommission + item.companyProfitCommission;
  console.log("remmain " +remainShareType);
  const shares = `${item.numberOfShares}/ ${item.soldShare} / ${remainShareType} `;
  const earned = `‚Çπ${item.companyCommission} / ‚Çπ${item.companyProfitCommission}`; 
  const active = item.isActive ? '‚úÖ' : '‚ùå';

  const $row = $("<tr></tr>");
  $row.append(`<td>${getCategoryName(item.categoryId)}</td>`);
  $row.append(`<td>${formatDateTime(item.startDate)}</td>`);
  $row.append(`<td>${formatDateTime(item.endDate)}</td>`);
  $row.append(`<td>‚Çπ${item.pricePerShare}</td>`);
  $row.append(`<td>${commission}</td>`);
  $row.append(`<td>${shares}</td>`);
  $row.append(`<td>${earned}</td>`);
  $row.append(`<td>${active}</td>`);

  const $editBtn = $(`<button class="btn btn-sm btn-warning">‚úèÔ∏è</button>`);
  $editBtn.on("click", () => editShareType(item));

  const $deleteBtn = $(`<button class="btn btn-sm btn-danger">üóëÔ∏è</button>`);
  $deleteBtn.on("click", () => deleteShareType(item.id));

  const $actionTd = $("<td></td>").append($editBtn, " ", $deleteBtn);
  $row.append($actionTd);

  tbody.append($row);
});

var totalRemaing = totalAllocatedShare - totalSoldShare;
$("#allocatedShares").text(totalAllocatedShare);
$("#soldShares").text(totalSoldShare);
$("#remainingShares").text(totalRemaing);
$("#earnedCompany").text(totalPlatformCommission);
$("#earnedProfit").text(totalProfitCommission);  
//$('#pricePerShare').val(sharePerAmount);

unsoldShare = 0;
unAllocated = 0;
if(totalShares > 0)
{
        unsoldShare = totalShares - totalSoldShare;
		unAllocated = totalShares - totalAllocatedShare;
}

$("#unsoldShares").text(unsoldShare); 
$("#unallocatedShares").text(unAllocated); 
$("#editUnallocated").text(unAllocated); 



    },
    error: function() {
      alert('‚ùå Failed to load share types');
    }
  });
}

// üîß Helper to map category ID to name
function getCategoryName(categoryId) {
  const categories = {
    1: "Normal",
    2: "Premium",
    3: "Trailer Release",
	4: "Day Before Release"
  };
  return categories[categoryId] || `Category #${categoryId}`;
}

function viewMovie(rowId)
{

openDropDown("#movieDetailPanel","movieDetailPanel.html");
sendAjaxRequest(readMovSummaryByIdURl+rowId, "GET", getAppHeaer(), null,movieDetailSumIDCallback );



}
function loadMovieSection()
	{
	
	var mvTable = $('#movieTable').DataTable({
		stripeClasses: [],
		     dom: '<"top"f>rt<"bottom"p><"clear">', // Only filter (f), remove length (l)
    pageLength: 10,
    lengthChange: false ,// hides "Show entries" dropdown
	processing: true,
    serverSide: true,
	   ajax: {
        url: readMovieUrl,
        type: 'POST',
        contentType: 'application/json',
		headers: getAppHeaer(),
        data: function (d) {
		 d.language =  $('#languageFilter').val();

  return JSON.stringify(d);                // üëà no wrapper!
        },
		dataFilter: function (responseStr) {
        const fullResponse = JSON.parse(responseStr);
        const obj = fullResponse.result;
        $("#movieCount").text(obj.recordsTotal ?? 0);
	    $("#movieCountFilter").text(obj.recordsFiltered);

      // Debug: make sure obj is valid
      return JSON.stringify({
        draw: obj.draw > 0 ? obj.draw : 1,
        recordsTotal: obj.recordsTotal ?? 0,
        recordsFiltered: obj.recordsFiltered ?? 0,
        data: obj.data ?? []
      });
    },
    error: function (xhr, status, error) {
      console.error('AJAX Error:', error);
	  Alert("Issue on dataLoading");
    }
      },
 columns: [
        {
          data: 'id',
          orderable: false,
          render: function (data) {  
            return `<input type="checkbox" class="rowCheckbox" value="${data}" onclick="enableRowSelected(this)">`;
          }	
        },
        {
      data: 'title',
      render: function (data, type, row) {
        const status = row.activeStatus === 'true';
        const color = status ? 'green' : 'red';
        const dot = `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${color};margin-right:8px;"></span>`;
        return `${dot}${data}`;
      }
    },
        { data: 'language' 
		   ,
		render: function(data, type, row)  {
		
		    const lang = getValueFromMap(languageMap,row.language )|| 'N/A';
           const typeName = getValueFromMap(idNameMovieTypeMap,row.movieTypeId) || 'N/A';
		
return `
      <div class="type-column">
        <span class="type-lang">${lang}</span>
        <span class="type-dot"> ¬∑ </span>
        <span class="type-name">${typeName}</span>
      </div>
    `; 
          }
		
		},
       // { data: 'budget' },
       		{
  data: 'shareSoldAmount',
  render: function(data, type, row) {
    const percent = row.fundingPercent || 0;
    const sold = row.sharesSold * row.perShareAmount;
    const total = row.totalShares * row.perShareAmount;

    return `
      <div>
        ‚Çπ${sold.toLocaleString()} 
        <small style="color:#888;">of ‚Çπ${total.toLocaleString()}</small>
        <div class="progress" style="height: 6px; margin-top: 4px;">
          <div class="progress-bar bg-success" role="progressbar" style="width: ${percent}%;" aria-valuenow="${percent}" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
      </div>`;
  }
}
,
{ data: 'perShareAmount' },
 
		 
		 
		 { 
      data: 'shareStatus', // or however you're mapping statusId
      render: function(data, type, row) {
       const colorMap = {
      'Live': 'badge-success',
      'Sold Out': 'badge-dark',
      'Not Started': 'badge-secondary',
      'Closed': 'badge-danger',
      'Day-Before Only': 'badge-warning'
    };
	const dayBending = row.daysBeforeRelease;
    const badgeClass = colorMap[data] || 'badge-info';
    return `<span class="badge ${badgeClass}">${data || 'N/A'} ${dayBending || 'N/A'}</span>`;
      }
    },
        { data: 'statusId' ,
          render: function (data) {
        let status = getValueFromMap(idNameMovieStatusMap,data);
       const badgeMap = {
      'idea stage': 'badge-idea',
      'pre-production': 'badge-pre',
      'funding open': 'badge-funding-open',
      'funding closed': 'badge-funding-closed',
      'production': 'badge-production',
      'post-production': 'badge-post',
      'trailer released': 'badge-trailer',
      'coming soon': 'badge-coming',
      'released': 'badge-released',
      'box office running': 'badge-boxoffice',
      'profit distribution': 'badge-profit',
      'archived': 'badge-archived',
      'on hold': 'badge-hold',
      'cancelled': 'badge-cancelled'
    };
    const badgeClass = badgeMap[status.toLowerCase()]; // default fallback
    return `<span class="">${status}</span>`;
  }
           
		
			   

		
		}
	/*,
        { data: 'movieTypeId',
		render: function (data) {
            return getValueFromMap(idNameMovieTypeMap,data);
          }

		}*/
		,
        {
          data: 'createdDate',
          render: function(data, type, row) {
           
    const created =  row.createdDate == null ? "N/A" : formatDateTime(row.createdDate);
    const trailer = row.trailerDate == null ? "N/A" :formatDateTime(row.trailerDate);
    const release = row.releaseDate == null ? "N/A" :formatDateTime(row.releaseDate);
        return `
      <div class="date-column">
        <div><span class="date-icon">üìÖ</span> <span class="date-label">Created:</span> <span class="date-value">${created}</span></div>
        <div><span class="date-icon">üéûÔ∏è</span> <span class="date-label">Trailer:</span> <span class="date-value">${trailer}</span></div>
        <div><span class="date-icon">üé¨</span> <span class="date-label">Release:</span> <span class="date-value">${release}</span></div>
      </div>
    `;
          }
        },
		
		
		
		
		{
          data: 'trailerUrl',
          render: function (data) {
     if (!data) return 'N/A';
    const videoId = extractYouTubeVideoID(data);
    if (!videoId) return `<span>${data}</span>`;

    const thumbnail = `https://img.youtube.com/vi/${videoId}/0.jpg`;
    return `
      <div class="preview-hover">
        <a href="${data}" target="_blank" style="text-decoration: none; color: inherit;">
          Watch
        </a>
        <div class="preview-box">
          <img src="${thumbnail}" alt="Trailer Preview">
        </div>
      </div>`;
	  
	  
	  
          }
        }
		,
        {
          data: 'posterUrl',
  render: function (data, type, row) {
    const safeTitle = row.title ? row.title.replace(/'/g, "\\'") : '';
const percent = row.fundingPercent || 0;
        const total = row.totalShares;

          return `
    <div class="action-column">
      <div class="action-link" onclick="viewMovie(${row.id})">View</div>
      <div class="action-link" onclick="manageCast(${row.id}, '${safeTitle}')">Casting</div>
      <div class="action-link" onclick="activateDayBefore(${row.id}, '${row.title.replace(/'/g, "\\'")}',${total},${row.perShareAmount})">ShareType</div>
    </div>
  `;
          }
        }
      ],
	   language: {
    emptyTable: "üîç No records found matching your criteria."
  },
    drawCallback: function () {
      //enableCheckboxSelectAll('movieTable');
    },
    initComplete: function () {
      const table = this.api();
      $(table.rows().nodes()).off('click').on('click', function (e) {
        if ($(e.target).is('input')) return;

        if($(this).hasClass("row_selected"))
							{
							 $(this).removeClass("row_selected");
							 var $checkboxValue=$(this).find("input:checkbox");
						     $checkboxValue.prop('checked',false);
							}
							else
							{
							 $(this).addClass("row_selected");
							 var $checkboxValue=$(this).find("input:checkbox");
							 $checkboxValue.prop('checked',true);
							}
      });
    },
    columnDefs: [
      { targets: 0, orderable: false, className: 'no-sort' }
    ]
	  
	
	
		   }
		   );
		   


		   $('#movieTable_filter input')
  .off() // unbind default search event
  .on('keyup', function (e) {
    if (e.key === 'Enter') {
      mvTable.search(this.value).draw();
    }
  });
	console.log(movieLanuguageList.length);
	if (!movieLanuguageList || movieLanuguageList.length > 0) {
	       populateLanguageSelect("languageFilter", movieLanuguageList,"language")

	  
           }


$('#languageFilter').on('change', function () {
    mvTable.ajax.reload();
  });
  
  
  currentTable = mvTable;
	
	}
	var movieDetailSumIDCallback = function (response)
	{
        console.log("movieDetailSumIDCallback" + response);	
		console.log(response);
		if(response != null)
		{
		  if(response.status == "success")
		  {
		     var data = response.result;
			 $("#movieTitle").text(data.title);
		     $("#movieCast").text(data.actorDetails);
			 $("#movieType").text(data.movieType);
			 $("#movieStatus").text( data.status);
			 $("#trailerDate").text( data.trailerDate);
			 $("#releaseDate").text( data.releaseDate);
			 $("#movieAmount").text( data.budget);
			 $("#collectedAmount").text( data.investedAmount);
			 var remaining = data.budget - data.investedAmount;
			 $("#pendingAmount").text(remaining);
			 $("#perShareAmount").text(data.perShareAmount);
             $("#moviePoster").attr("src", returnEmptyForNull(data.posterUrl));

			 
		  
		  }
		
		
		}
	
	}
	function returnEmptyForNull(inputx)
	{
	  return  inputx == null ? "" :inputx;
	
	}
currentMovieName = "";
currentMovieShare = 0;
currentMoviePerShare = 0;
function activateDayBefore(movId,movName,totalShareCount,perShare)
{
currentCastMovId = movId;
currentMovieName = movName;
currentMovieShare = totalShareCount; 
currentMoviePerShare = perShare;     
     openDropDownWithCallBack("#shareTypeModal","share-type-modal.html",openShareTypeWinCallBack);



}
var currentCastMovId ;
var currentCastMovName;

var castingCallBack = function()
{
   
$('#castingMovieId').val(currentCastMovId);
  $('#castingMovieTitle').text(currentCastMovName);
  $('#roleInMovie').val('');
  $('#actorSelect').val('');
  $('#castingTableBody').empty(); // clear old data

  // Optionally fetch existing cast from backend
  //fetchCastList(movieId);
  if (movieLanuguageList != null && movieLanuguageList.length > 0) {
	  	       populateLanguageSelect("castingLang", movieLanuguageList,"addlanguage");
  }
  
  if (actorRolelist != null && actorRolelist.length > 0) {
	  	       populateLanguageSelect("roleInMovieSelect", actorRolelist,"");
  }
  else
  {
     	 
   sendAjaxRequest(readMovieRolesUrl, "GET", getAppHeaer(), null,castingRoleFun );
  
  }
     sendAjaxRequest(readActorInMovByMovIdUrl+currentCastMovId, "GET", getAppHeaer(), null,drawdrawActorRoleMovTableFun );

  
  $('#castingModal').modal('show');

}

var castingRoleFun = function (data)
{

if(data.status === "success")
   {
     console.log("castingRoleFun");
	 if(data.result != null )
	 {
	      var keyMap = getKeyValueMapIdName(data.result)
		  var arrayObj = convertMapToArray(keyMap);
		  actorRolelist = arrayObj;
	  	       populateLanguageSelect("roleInMovieSelect", actorRolelist,"");

	 }
   
      
   }

}


var casttingLangSelectFun = function (data)
{
   if(data.status === "success")
   {
	 if(data.result != null )
	 {
	       var keyMap = getKeyValueMapIdName(data.result)
		   var arrayObj = convertMapToArray(keyMap);
	       populateLanguageSelect("actorSelect", arrayObj,"");

	 }
   
      
   }



}


function loadActorsByLanguage(language) {
  if (!language) {
    $('#actorSelect').html('<option value="">Select Actor</option>');
    return;
  }
  
  	 sendAjaxRequest(readActorsBylanIdUrl+language, "GET", getAppHeaer(), null,casttingLangSelectFun );


 
}

var listActorInMovie = function listMovieInActorCallBack(data)
{
  if(data.success === "success")
  {
  
     drawdrawActorRoleMovTableFun(data);
  
  }


}

var addRoleInMovieFun = function(response)
{

 if(response.status === "success")
 {
    
	     sendAjaxRequest(readActorInMovByMovIdUrl+currentCastMovId, "GET", getAppHeaer(), null,drawdrawActorRoleMovTableFun );

    //drawdrawActorRoleMovTableFun(response);

 }
 else {
        if(response.status === "failure")
		    alert("‚ùå Failed to save movie. " + response.message);

 
 
 }



}

var drawdrawActorRoleMovTableFun = function drawActorRoleMovieTable(response)
{
     if(response.status == "success")
	 {
	 $('#castingTableBody').empty();
      response.result.forEach(function(record, index) {
                const rowCount = index + 1;  // Index starts from 0, so add 1 for row number
                const roleName =record.roleName; // You'll need to fetch or map the role name
                const actorName = record.actorName; // Similarly, map actorId to actorName
                const id = record.id;
                // Create a new row
                const newRow = `
                    <tr>
                        <td>${rowCount}</td>
                        <td>${roleName}</td>
                        <td>${actorName}</td>
                        <td>
                            <span class="text-primary" style="cursor:pointer;" onclick="editCast(${id})">üñâ</span>
                            <span class="text-danger ms-2" style="cursor:pointer;" onclick="deleteCast(${id})">üóë</span>
                        </td>
                    </tr>
                `;
                // Append the new row to the table body
                $('#castingTableBody').append(newRow);
            });
   

  // Reset fields
  $('#roleInMovie').val('');
  $('#actorSelect').val('');
  $('#castingLang').val('');
}
}

function addCastEntry() {
  const role = $('#roleInMovieSelect').val();
  const actorId = $('#actorSelect').val();
  const actorName = $('#actorSelect option:selected').text();
  const roleName = $('#roleInMovieSelect option:selected').text();
  const language = $('#castingLang').val();
  console.log("lang selected " + language);

  // Hide all previous error messages
  $('.error-message').hide();

  // Check if all fields are selected
  let isValid = true;
  
  if (!language) {
    $('#languageError').show();
    isValid = false;
  }
  if (!role) {
    $('#roleError').show();
    isValid = false;
  }
  if (!actorId) {
    $('#actorError').show();
    isValid = false;
  }

  // Stop if any field is invalid
  if (!isValid) {
    return;
  }
 
     var input = {};
	 input.movieId = currentCastMovId;
	 input.actorId    = parseInt(actorId); // 123
	 input.roleMovieId =parseInt(role) ;
	 input.id = 0;
	 console.log("casting save ");
	 console.log(input);
  	 sendAjaxRequest(addActorInMovieUrl, "POST", getAppHeaer(), input , addRoleInMovieFun );
 
  
  
  

  
}


function editCast(castId) {
}

function deleteCast(castId) {
console.log("delte id" + castId);
const confirmDelete = confirm("Are you sure you want to delete this cast record?");
    
    if (confirmDelete) {
        console.log("Delete confirmed. ID:", castId);
		sendAjaxRequest(deleteActorInMovieUrl+castId, "GET", getAppHeaer(), null , addRoleInMovieFun );


        // TODO: Call your delete AJAX function here
        // Example:
        // sendAjaxRequest(deleteUrl, "DELETE", getAppHeaer(), JSON.stringify({ id: castId }), callbackFn);
    } else {
        console.log("Delete cancelled.");
    }
  
}

function manageCast(movieId, movieName) {

currentCastMovId = movieId;
currentCastMovName =movieName;


     openDropDownWithCallBack("#castingModal","castingModal.html",castingCallBack);
  
}

var setMovieAddSelect = function ()
{
	  if (movieLanuguageList != null && movieLanuguageList.length > 0) {
	  	       populateLanguageSelect("mLanguageSelect", movieLanuguageList,"addlanguage");
			   }
			   

		if (Object.keys(idNameMovieTypeMap).length > 0) { 
                 var arrayObj = convertMapToArray(idNameMovieTypeMap);
	  	       populateLanguageSelect("addmovieTypeSelect", arrayObj,"");
			   }	
			   
			  if (Object.keys(idNameMovieStatusMap).length > 0) { 
			                    var arrayObj = convertMapToArray(idNameMovieStatusMap);

	  	       populateLanguageSelect("addstatusSelect", arrayObj,"");
			   }	
    			   
			   
 
}


  function closeMoviePanel() {
   $("#movieDetailPanel").fadeOut(200, function () {
    $(this).css("display", "none");
  });
}
	
function openDropDown(modalId,page)
{


console.log("comming inside");
    $("#modalContainer").empty();

    $('#modalContainer').load(page, function () {
	 console.log("comming inside");
      $(modalId).modal('show');
    });
  
  



}

	
  $(document).ready(function () {
 
   // Investment Trend Chart
   //showPopupLoader();
   $(document).ready(function () {
  $('.sidebar').hover(
    function () {
      $(this).addClass('expanded');
      $('.main-content').addClass('shifted');
    },
    function () {
      $(this).removeClass('expanded');
      $('.main-content').removeClass('shifted');
    }
  );
  
	
  
});

   
   loadSection('dashboard');
    
 
  });
  
  function showPopupLoader() {
  $('#loadingPopup').show();
}

function hidePopupLoader() {
  $('#loadingPopup').hide();
}
  function callMovieTable()
  {
  $('#movieTable').DataTable({
      serverSide: true,
      processing: true,
      ajax: {
        url: '/api/movies', // Replace with your backend URL
        type: 'GET',
        dataSrc: function (json) {
          // You can transform data here if needed
          return json.data;
        }
      },
     columns: [
  {
    data: 'id',
    orderable: false,
    render: function (data) {
      return `<input type="checkbox" class="rowCheckbox" value="${data}">`;
    }
  },
  { data: 'title' },
  { data: 'description' },
  { data: 'language' },
  { data: 'budget' },
  { data: 'perShareAmount' },
  { data: 'statusId' },
  { data: 'movieTypeId' },
  {
    data: 'posterUrl',
    render: function(data) {
      return `<img src="${data}" width="50" height="50"/>`;
    }
  },
  {
    data: 'trailerUrl',
    render: function(data) {
      return `<a href="${data}" target="_blank">Trailer</a>`;
    }
  },
  {
    data: 'createdDate',
    render: function(data) {
      return new Date(data).toLocaleDateString();
    }
  },
  {
    data: 'releaseDate',
    render: function(data) {
      return data ? new Date(data).toLocaleDateString() : 'Coming Soon';
    }
  },
  {
    data: 'id',
    render: function(data) {
      return `<button onclick="editMovie(${data})">Edit</button> <button onclick="deleteMovie(${data})">Delete</button>`;
    }
  }
]
,
      pageLength: 10,
      lengthMenu: [10, 20, 50, 100]
    });
  
  
  }


// annoncement

  let announcements = [
    { id: 1, title: "New Movie: Sky Flame", date: "2025-06-10", status: "Active" },
    { id: 2, title: "Server Maintenance", date: "2025-06-05", status: "Inactive" }
  ];

  let announcementTable;

  function renderAnnouncementsTable() {
    const tbody = $('#announcementTable tbody');
    tbody.empty();

    announcements.forEach((a, i) => {
      tbody.append(`
        <tr>
          <td>${i + 1}</td>
          <td>${a.title}</td>
          <td>${a.date}</td>
          <td><span class="badge ${a.status === 'Active' ? 'bg-success' : 'bg-secondary'}">${a.status}</span></td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="editAnnouncement(${a.id})">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteAnnouncement(${a.id})">Delete</button>
          </td>
        </tr>
      `);
    });

    if ($.fn.DataTable.isDataTable('#announcementTable')) {
      $('#announcementTable').DataTable().destroy(); // reinit
    }

    $('#announcementTable').DataTable({
      pageLength: 5,
      ordering: true,
      stripeClasses: ['table-light', ''],
      language: {
        searchPlaceholder: "Search announcement..."
      }
    });
  }

  function openAnnouncementModal() {
  
  openDropDown('#announcementModal','add-annoncement-modal.html');
  
  
    $('#announcementId').val('');
    $('#announcementTitle').val('');
    $('#announcementMessage').val('');
    $('#announcementDate').val(new Date().toISOString().split('T')[0]);
    $('#announcementStatus').val('Active');
    $('#announcementModal').addClass('show');
  }

  function closeAnnouncementModal() {
  $('#modalContainer').hide(); // removes modal HTML

  }

  function saveAnnouncement() {
    const id = $('#announcementId').val();
    const title = $('#announcementTitle').val();
    const date = $('#announcementDate').val();
    const status = $('#announcementStatus').val();

    if (id) {
      const index = announcements.findIndex(a => a.id == id);
      announcements[index] = { id: Number(id), title, date, status };
    } else {
      const newId = announcements.length ? announcements[announcements.length - 1].id + 1 : 1;
      announcements.push({ id: newId, title, date, status });
    }

    closeAnnouncementModal();
    renderAnnouncementsTable();
  }

  function editAnnouncement(id) {
    const a = announcements.find(a => a.id == id);
    $('#announcementId').val(a.id);
    $('#announcementTitle').val(a.title);
    $('#announcementDate').val(a.date);
    $('#announcementStatus').val(a.status);
    $('#announcementModal').addClass('show');
  }

  function deleteAnnouncement(id) {
    if (confirm("Are you sure you want to delete this?")) {
      announcements = announcements.filter(a => a.id != id);
      renderAnnouncementsTable();
    }
  }

// reports
 

  function renderReportCharts() {
  
    new Chart(document.getElementById('reportinvestmentChart'), {
      type: 'line',
      data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
        datasets: [{
          label: 'Monthly Investments',
          data: [15, 25, 35, 28, 40, 22],
          borderColor: '#FFD700',
          backgroundColor: 'rgba(255, 215, 0, 0.2)',
          tension: 0.4
        }]
      }
    });

    new Chart(document.getElementById('reportsuserGrowthChart'), {
      type: 'bar',
      data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
        datasets: [{
          label: 'New Users',
          data: [300, 400, 520, 600, 750, 850],
          backgroundColor: '#FFD700'
        }]
      }
    });
  }

  function exportCSV() {
    alert("CSV Export (hook your backend later)");
  }

  function exportPDF() {
    alert("PDF Export (you can integrate html2pdf or jsPDF)");
  }

  

  
  function openActorModal() {
      openDropDown('#actorModal','add_actor_modal.html');
	      $('#actorForm')[0].reset();

  }

  function closeActorModal() {
    actorModal.hide();
  }

  function saveActor() {
    const values = $('#actorForm').serializeArray().map(i => i.value);
    const newRow = `
      <tr>
        <td>${values[0]}</td>
        <td>${values[1]}</td>
        <td>${values[2]}</td>
        <td>${values[3]}</td>
        <td>${values[4]}</td>
        <td>${values[5]}</td>
        <td><img src="${values[6]}" alt="Actor" width="40"></td>
      </tr>`;
    $('#actorTable tbody').append(newRow);
    actorTable.row.add($(newRow)).draw();
    closeActorModal();
  }
  
  
  function enableRowSelected(checkbox) {
  const $checkbox = $(checkbox);
  const $row = $checkbox.closest('tr');

  if ($checkbox.is(':checked')) {
    $row.addClass('row_selected');
  } else {
    $row.removeClass('row_selected');
  }
  
  }
  
  
 





function closeModelWindowById(modalId)
{
  const modalElement = document.getElementById(modalId);
  const modalInstance = bootstrap.Modal.getInstance(modalElement);
  if (modalInstance) {
    modalInstance.hide();
  }
  // Cleanup fallback (optional)
  document.body.classList.remove('modal-open');
  document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
	
}
function formatDateTime(dateString) {
  const date = new Date(dateString);

  const pad = n => (n < 10 ? '0' + n : n);

  const day = pad(date.getDate());
  const month = pad(date.getMonth() + 1);
  const year = date.getFullYear();

  const hours = pad(date.getHours());
  const minutes = pad(date.getMinutes());

  return `${day}-${month}-${year} ${hours}:${minutes}`;
}


function extractYouTubeVideoID(url) {
  const regExp = /(?:youtube\.com.*(?:\?v=|\/embed\/)|youtu\.be\/)([a-zA-Z0-9_-]+)/;
  const match = url.match(regExp);
  return match ? match[1] : null;
}

function toFullSqlTimestamp(value) {
  if (!value) return "";
  if (value.length === 16) value += ":00"; // Add seconds
  return value.replace("T", " ") + ".000"; // Add space and milliseconds
}

  </script>
  <style>
 
  </style>
</head>
<body>

<div id="loadingPopup" style="display: none;">
  <div class="loading-popup-backdrop"></div>
  <div class="loading-popup-box">
    <div class="spinner-border text-warning" role="status"></div>
    <div class="loading-text mt-2">Loading, please wait...</div>
  </div>
</div>

<!-- Add Movie Modal -->
<div id="modalContainer"></div>





  <!-- Top Navbar -->
  <nav class="navbar navbar-dark bg-dark fixed-top px-3">
    <span class="navbar-brand">üé¨ FilmBit Admin Panel</span>
    <a href="#" class="logout-btn">üîì Logout</a>
  </nav>

  <!-- Sidebar -->
  <div class="sidebar pt-5">
    <ul class="nav flex-column">
      <li class="nav-item"><a class="nav-link" href="#" onclick="loadSection('dashboard')">üìä <span class="nav-text">Dashboard</span></a></li>
     <li class="nav-item">
    <a class="nav-link" href="#filmSubmenu" data-bs-toggle="collapse">
      üé¨ <span class="nav-text">Film</span>
    </a>
    <ul class="collapse list-unstyled ps-3" id="filmSubmenu">
      <li><a class="nav-link" href="#" onclick="loadSection('movies')" data-section="movies">üé¨ <span class="nav-text">Movies</span></a></li>
      <li><a class="nav-link" href="#" onclick="loadSection('actors')" data-section="actors">üßë <span class="nav-text">Actors</span></a></li>
      <li><a class="nav-link" href="#" onclick="loadSection('roles')" data-section="roles">üë• <span class="nav-text">Role Play</span></a></li>
    </ul>
  </li>
  
       <li class="nav-item">
    <a class="nav-link" href="#financeSubmenu" data-bs-toggle="collapse">
      üí∞ <span class="nav-text">Finance</span>
    </a>
    <ul class="collapse list-unstyled ps-3" id="financeSubmenu">
<li class="nav-item"><a class="nav-link" href="#" onclick="loadSection('investments')" data-section="investments"> üíº<span class="nav-text">Investments</span></a></li>
      <li class="nav-item"><a class="nav-link" href="#" onclick="loadSection('payouts')" data-section="payouts">üì§ <span class="nav-text">Payouts</span></a></li>

    </ul>
  </li>
      <li class="nav-item"><a class="nav-link" href="#" onclick="loadSection('users')" data-section="Users">üë®‚Äçüíº <span class="nav-text">Users</span></a></li>
	  <li class="nav-item"><a class="nav-link" href="#" onclick="loadSection('announcements')" data-section="Announcements">üì£ <span class="nav-text">Announcements</span></a></li>
	 <li class="nav-item"><a class="nav-link" href="#" onclick="loadSection('offerPromotion')" data-section="offerPromotion">üì£ <span class="nav-text">Offer & Promo</span></a></li>
 
	  <li class="nav-item"><a class="nav-link" href="#" onclick="loadSection('reports')" data-section="Reports">üìà  <span class="nav-text">Reports</span></a></li>
      <li class="nav-item"><a class="nav-link" href="#" onclick="loadSection('settings')" data-section="Settings">‚öôÔ∏è <span class="nav-text">Settings</span></a></li>
    </ul>
  </div>

  <!-- Main Content -->
  
  <div class="main-content">
    <div class="header">
      <h5 class="m-0">üé¨ FilmBit Admin</h5>
    </div>

    <div class="content-area">
	
	
	
      <!-- Sections -->
     <div id="dashboard-section"></div>
   

<div id = "movies-section"> </div>

      <div id="actors-section" style="display: none;"></div>
      <div id="roles-section" style="display: none;"></div>
      <div id="users-section" style="display: none;"></div>
      <div id="investments-section" style="display: none;"></div>
      <div id="reports-section" style="display: none;"></div>
      <div id="announcements-section" style="display: none;"></div>
      <div id="payouts-section" style="display: none;"></div>
      <div id="settings-section" style="display: none;"></div>
	  <div id="offerPromotion-section" style="display: none;"></div>

	  
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
